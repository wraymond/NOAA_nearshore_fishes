---
title: "Analysis_model_building"
author: "Wendel Raymond"
date: "October 1, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Model building
Using the data prepared from the data preparation script we can now beging model building. Before we can run a PERMANOVA we will need to prep the response and explanatory data. After that we will generate a global model and eventually best model, testing the effect of habitat on fish community composition.

```{r data}
dat <- read.csv("Data/SEAK_EventID_mass.csv", header = TRUE, stringsAsFactors = TRUE)
```

```{r libraries}
library(dplyr)
library(tidyr)
library(vegan)
```

## Prepping response and explanatory data
For ease of processing later we will separate the response data (species and mass) from the explanatory data (EventID, date, month, temp, salinity, etc.)

```{r separating}
## Site data ##
names(dat)
site <- unique(dat[, 2:17])
duplicated(site$EventID)

## Fish data ##
fish <- dat[, c(1, 2, 18)]
duplicated(fish)
fish <- spread(fish, SpCode, mass_g)
fish[is.na(fish)] <- 0
colSums(fish) # UNLARV has no data whatsoever
fish <- fish[, c(1:84, 86:97)]
```

## Standarizations and Transformations
The data are very noisy, cover a huge range of values, and contain many zeros. I will standardize the data to species maximum and the to total catch of that EventID. That way catch will be realative to total for that species but also relative to other EventIDs.

```{r standardization}
## To species maximum ##
fish.std <- scale(fish[,2:96], center = FALSE, scale = apply(fish[,2:96], 2, max))

## To EventID total ##
fish.std <- fish.std/rowSums(fish[,2:96])
```

## Dissimilarity
Calculate dissimilarity matrix in preparation for PERMANOVA
```{r dissim}
dist.bray <- vegdist(fish.std, method = "bray")
```

## Model - PERMANOVA
```{r perm}
mod1 <- adonis2(dist.bray ~ habitat)
```

